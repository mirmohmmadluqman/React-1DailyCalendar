<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>1 Daily Calendar</title>
  <link rel="icon" href="Elements/myLogo.jpg" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-primary-dark: #121212;
      --bg-secondary-dark: #2A2A2A;
      --text-primary-dark: #E5E5E5;
      --text-heading-dark: #FFFFFF;
      --bg-primary-light: #FFFFFF;
      --bg-secondary-light: #F5F5F5;
      --text-primary-light: #333333;
      --text-heading-light: #000000;
      --accent-start: #9747FF;
      --accent-end: #FF47A8;
      --border-color-dark: #63636356;
      --border-color-light: #E5E7EB;
      --shadow: 0 10px 15px -3px rgba(0,0,0,.1), 0 4px 6px -4px rgba(0,0,0,.1);
      --transition: 0.3s ease;
      --font-size-base: 16px;
      --font-scale: 1;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: 'Inter', sans-serif;
      font-size: calc(var(--font-size-base) * var(--font-scale));
      line-height: 1.5;
      background-color: var(--bg-primary-dark);
      color: var(--text-primary-dark);
      transition: background-color var(--transition), color var(--transition);
      min-height: 100vh;
    }
    body.light {
      background-color: var(--bg-primary-light);
      color: var(--text-primary-light);
    }

    /* Custom Scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    ::-webkit-scrollbar-track {
      background: var(--bg-secondary-dark);
      border-radius: 10px;
    }
    ::-webkit-scrollbar-thumb {
      background: var(--accent-start);
      border-radius: 10px;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: var(--accent-end);
    }
    body.light ::-webkit-scrollbar-track {
      background: var(--bg-secondary-light);
    }
    body.light ::-webkit-scrollbar-thumb {
      background: var(--accent-start);
    }
    body.light ::-webkit-scrollbar-thumb:hover {
      background: var(--accent-end);
    }

    header {
      position: relative;
      margin: 25px auto 0;
      display: flex;
      flex-wrap: wrap;
      width: 90%;
      max-width: 1400px;
      align-items: center;
      justify-content: space-between;
      border-radius: .5rem;
      border: 1px solid var(--border-color-dark);
      background-color: rgba(0,0,0,.2);
      padding: 0.5rem 1rem;
      box-shadow: var(--shadow);
      transition: border-color var(--transition), background-color var(--transition);
    }
    @supports (backdrop-filter: blur(4px)) {
      header {
        backdrop-filter: blur(4px);
      }
    }
    @supports not (backdrop-filter: blur(4px)) {
      header {
        background-color: rgba(0,0,0,.4);
      }
    }
    body.light header {
      border-color: var(--border-color-light);
      background-color: rgba(255,255,255,.2);
    }
    @supports not (backdrop-filter: blur(4px)) {
      body.light header {
        background-color: rgba(255,255,255,.4);
      }
    }

    .header-title-container {
      position: relative;
      display: flex;
      align-items: center;
      margin-bottom: 0.5rem;
    }
    header h1 {
      font-family: 'Inter', sans-serif;
      font-weight: 700;
      font-size: calc(var(--font-size-base) * var(--font-scale) * 1.8);
      color: var(--text-heading-dark);
      margin: 0;
    }
    body.light header h1 {
      color: var(--text-heading-light);
    }

    button {
      cursor: pointer;
      position: relative;
      white-space: nowrap;
      border-radius: 9999px;
      border: 1px solid #363636;
      background-image: linear-gradient(to bottom, #424242, #212121);
      padding: 0.25rem 1.75rem;
      font-family: 'Inter', sans-serif;
      font-weight: 700;
      font-size: calc(var(--font-size-base) * var(--font-scale));
      color: #FFFFFF;
      box-shadow: var(--shadow);
      transition: transform var(--transition), filter var(--transition);
      min-width: 44px;
      min-height: 44px;
    }
    body.light button {
      border-color: #D1D5DB;
      background-image: linear-gradient(to bottom, #E5E5E5, #D1D5DB);
      color: #333333;
    }
    button:hover {
      transform: scale(1.05);
      filter: brightness(1.1);
    }
    button:active {
      transform: scale(0.95);
    }
    button::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 2px;
      background: #FFFFFF;
      transition: width 0.3s ease;
    }
    body.light button::after {
      background: #333333;
    }
    button:hover::after {
      width: 80%;
    }

    #themeToggleBtn, #settingsBtn, #statsBtn, #timerBtn {
      width: 32px;
      height: 32px;
      border-radius: 9999px;
      padding: 0;
      font-size: calc(var(--font-size-base) * var(--font-scale));
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: var(--shadow);
      margin-left: 1rem;
    }

    .header-buttons {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .calendar-header {
      margin: 2rem auto;
      width: 90%;
      max-width: 1400px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .calendar-header h2 {
      font-size: calc(var(--font-size-base) * var(--font-scale) * 1.5);
      font-weight: 700;
      color: var(--text-heading-dark);
      transition: color var(--transition);
    }
    body.light .calendar-header h2 {
      color: var(--text-heading-light);
    }

    .calendar-controls {
      display: flex;
      gap: 1rem;
      align-items: center;
      flex-wrap: wrap;
    }

    .calendar-grid {
      width: 90%;
      max-width: 1400px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 0.5rem;
    }

    .calendar-grid div {
      aspect-ratio: 1;
      border: 1px solid var(--border-color-dark);
      border-radius: 0.5rem;
      padding: 0.5rem;
      background-color: var(--bg-secondary-dark);
      position: relative;
      overflow: hidden;
      transition: background-color var(--transition), border-color var(--transition);
    }
    body.light .calendar-grid div {
      border-color: var(--border-color-light);
      background-color: var(--bg-secondary-light);
    }

    .calendar-grid .day-header {
      text-align: center;
      font-weight: 700;
      background-color: transparent;
      border: none;
    }

    .calendar-grid .day {
      cursor: pointer;
    }

    .calendar-grid .day:hover {
      background-color: rgba(151, 71, 255, 0.2);
    }

    .calendar-grid .day.today {
      border: 2px solid var(--accent-start);
    }

    .calendar-grid .day.holiday {
      background-color: rgba(255, 215, 0, 0.2);
    }

    .calendar-grid .day-number {
      position: absolute;
      top: 0.25rem;
      left: 0.25rem;
      font-size: calc(var(--font-size-base) * var(--font-scale));
      font-weight: 700;
    }

    .calendar-grid .notes {
      margin-top: 1.5rem;
      font-size: calc(var(--font-size-base) * var(--font-scale) * 0.8);
      max-height: calc(100% - 2rem);
      overflow-y: auto;
    }

    .calendar-grid .note {
      padding: 0.25rem;
      border-radius: 0.25rem;
      margin-bottom: 0.25rem;
    }

    .calendar-grid .note.pinned {
      font-weight: 700;
      background-color: rgba(255, 255, 255, 0.1);
    }
    body.light .calendar-grid .note.pinned {
      background-color: rgba(0, 0, 0, 0.1);
    }

    #noteEditor, #searchPopup, #statsPopup, #settingsPopup, #timerPopup {
      position: fixed;
      top: 50%;
      left: 50%;
      width: 90%;
      max-width: 500px;
      max-height: 80vh;
      background-color: var(--bg-secondary-dark);
      border-radius: 12px;
      box-shadow: var(--shadow);
      transform: translate(-50%, -50%) scale(0.7);
      opacity: 0;
      pointer-events: none;
      transition: transform var(--transition), opacity var(--transition);
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      z-index: 1000;
      overflow-y: auto;
    }
    body.light #noteEditor, body.light #searchPopup, body.light #statsPopup, body.light #settingsPopup, body.light #timerPopup {
      background-color: var(--bg-secondary-light);
    }

    #noteEditor.open, #searchPopup.open, #statsPopup.open, #settingsPopup.open, #timerPopup.open {
      opacity: 1;
      pointer-events: auto;
      transform: translate(-50%, -50%) scale(1);
    }

    #overlay {
      position: fixed;
      inset: 0;
      background-color: rgba(0, 0, 0, 0.5);
      opacity: 0;
      pointer-events: none;
      transition: opacity var(--transition);
      z-index: 900;
    }

    #overlay.open {
      opacity: 1;
      pointer-events: auto;
    }

    #noteEditor h2, #searchPopup h2, #statsPopup h2, #settingsPopup h2, #timerPopup h2 {
      font-size: calc(var(--font-size-base) * var(--font-scale) * 1.5);
      font-weight: 700;
      color: var(--text-heading-dark);
      margin-bottom: 1.5rem;
      transition: color var(--transition);
    }
    body.light #noteEditor h2, body.light #searchPopup h2, body.light #statsPopup h2, body.light #settingsPopup h2, body.light #timerPopup h2 {
      color: var(--text-heading-light);
    }

    #noteEditor label, #settingsPopup label {
      font-size: calc(var(--font-size-base) * var(--font-scale));
      margin-bottom: 0.5rem;
      display: block;
      font-weight: 500;
    }

    #noteEditor input, #noteEditor textarea, #noteEditor select, #settingsPopup input, #settingsPopup select {
      width: 100%;
      padding: 0.5rem;
      margin-bottom: 1rem;
      font-size: calc(var(--font-size-base) * var(--font-scale));
      border-radius: 8px;
      border: 1px solid var(--border-color-dark);
      background-color: var(--bg-primary-dark);
      color: var(--text-primary-dark);
      transition: border-color var(--transition), background-color var(--transition), color var(--transition);
      box-sizing: border-box;
    }
    body.light #noteEditor input, body.light #noteEditor textarea, body.light #noteEditor select, body.light #settingsPopup input, body.light #settingsPopup select {
      border-color: var(--border-color-light);
      background-color: var(--bg-primary-light);
      color: var(--text-primary-light);
    }

    #noteEditor textarea {
      min-height: 100px;
      resize: vertical;
    }

    #noteEditor .editor-buttons, #timerPopup .timer-controls {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      margin-top: 0.5rem;
    }

    #voiceInputBtn {
      width: 32px;
      height: 32px;
      border-radius: 9999px;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #searchBar {
      margin: 2rem auto 0;
      width: 90%;
      max-width: 600px;
      padding: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      border-radius: 9999px;
      border: 1px solid var(--border-color-dark);
      background-color: var(--bg-secondary-dark);
      transition: border-color var(--transition), background-color var(--transition);
      margin-bottom: 1rem;
    }
    body.light #searchBar {
      border-color: var(--border-color-light);
      background-color: var(--bg-secondary-light);
    }

    #searchInput {
      flex: 1;
      border: none;
      background: transparent;
      color: var(--text-primary-dark);
      font-size: calc(var(--font-size-base) * var(--font-scale));
      outline: none;
    }
    body.light #searchInput {
      color: var(--text-primary-light);
    }

    #searchInput::placeholder {
      color: var(--text-primary-dark);
      opacity: 0.7;
    }
    body.light #searchInput::placeholder {
      color: var(--text-primary-light);
    }

    #searchResults {
      margin-top: 1rem;
      max-height: 50vh;
      overflow-y: auto;
    }

    .search-result {
      padding: 0.5rem;
      border-bottom: 1px solid var(--border-color-dark);
      cursor: pointer;
      transition: background-color var(--transition);
    }
    body.light .search-result {
      border-bottom-color: var(--border-color-light);
    }

    .search-result:hover {
      background-color: rgba(151, 71, 255, 0.2);
    }

    #floatingButton {
      position: fixed;
      bottom: 1rem;
      right: 1rem;
      width: 48px;
      height: 48px;
      border-radius: 9999px;
      font-size: calc(var(--font-size-base) * var(--font-scale) * 1.5);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: var(--shadow);
    }

    .time-used, .reminder-section {
      margin-top: 0.75rem;
      font-size: calc(var(--font-size-base) * var(--font-scale) * 0.9);
      color: var(--text-primary-dark);
      transition: color var(--transition);
    }
    body.light .time-used, body.light .reminder-section {
      color: var(--text-primary-light);
    }

    .timer-mode-buttons {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }

    .timer-mode-buttons button {
      padding: 0.5rem 1rem;
      font-size: calc(var(--font-size-base) * var(--font-scale) * 0.9);
    }

    .timer-mode-buttons button.active {
      background-image: linear-gradient(to bottom, var(--accent-start), var(--accent-end));
    }

    .timer-display {
      font-size: calc(var(--font-size-base) * var(--font-scale) * 2);
      font-weight: 700;
      text-align: center;
      margin-bottom: 1rem;
    }

    .settings-section {
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--border-color-dark);
    }
    body.light .settings-section {
      border-bottom-color: var(--border-color-light);
    }

    .settings-section:last-of-type {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }

    .settings-buttons {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      margin-top: 1rem;
    }

    .file-info {
      font-size: calc(var(--font-size-base) * var(--font-scale) * 0.9);
      color: var(--text-primary-dark);
      margin-top: 0.5rem;
      word-break: break-all;
    }
    body.light .file-info {
      color: var(--text-primary-light);
    }

    /* Media Queries for Responsiveness */
    @media (max-width: 768px) {
      header {
        flex-direction: column;
        padding: 0.5rem;
      }
      header h1 {
        font-size: calc(var(--font-size-base) * var(--font-scale) * 1.5);
      }
      .header-title-container {
        width: 100%;
        justify-content: center;
      }
      .header-buttons {
        margin-top: 0.5rem;
        justify-content: center;
      }
      #themeToggleBtn, #settingsBtn, #statsBtn, #timerBtn {
        margin-left: 0;
      }
      .calendar-header {
        flex-direction: column;
        align-items: flex-start;
      }
      .calendar-header h2 {
        font-size: calc(var(--font-size-base) * var(--font-scale) * 1.3);
      }
      .calendar-controls {
        width: 100%;
        justify-content: center;
      }
      .calendar-grid {
        grid-template-columns: repeat(7, 1fr);
        gap: 0.25rem;
      }
      .calendar-grid div {
        padding: 0.25rem;
        font-size: calc(var(--font-size-base) * var(--font-scale) * 0.9);
      }
      .calendar-grid .day-number {
        font-size: calc(var(--font-size-base) * var(--font-scale) * 0.9);
      }
      .calendar-grid .notes {
        margin-top: 1rem;
        font-size: calc(var(--font-size-base) * var(--font-scale) * 0.7);
      }
      #noteEditor, #searchPopup, #statsPopup, #settingsPopup, #timerPopup {
        width: 95%;
        padding: 1rem;
      }
    }

    @media (max-width: 480px) {
      header h1 {
        font-size: calc(var(--font-size-base) * var(--font-scale) * 1.2);
      }
      .calendar-header h2 {
        font-size: calc(var(--font-size-base) * var(--font-scale) * 1.1);
      }
      .calendar-grid {
        grid-template-columns: repeat(7, 1fr);
        gap: 0.1rem;
      }
      .calendar-grid div {
        padding: 0.2rem;
        font-size: calc(var(--font-size-base) * var(--font-scale) * 0.8);
      }
      .calendar-grid .day-number {
        font-size: calc(var(--font-size-base) * var(--font-scale) * 0.8);
      }
      .calendar-grid .notes {
        margin-top: 0.8rem;
        font-size: calc(var(--font-size-base) * var(--font-scale) * 0.6);
      }
      button {
        padding: 0.25rem 1rem;
        font-size: calc(var(--font-size-base) * var(--font-scale) * 0.9);
      }
      #themeToggleBtn, #settingsBtn, #statsBtn, #timerBtn {
        width: 28px;
        height: 28px;
        font-size: calc(var(--font-size-base) * var(--font-scale) * 0.9);
      }
      #floatingButton {
        width: 40px;
        height: 40px;
        font-size: calc(var(--font-size-base) * var(--font-scale) * 1.2);
      }
    }

    @media (max-width: 320px) {
      header h1 {
        font-size: calc(var(--font-size-base) * var(--font-scale));
      }
      .calendar-header h2 {
        font-size: calc(var(--font-size-base) * var(--font-scale));
      }
      .calendar-grid div {
        font-size: calc(var(--font-size-base) * var(--font-scale) * 0.7);
      }
      .calendar-grid .day-number {
        font-size: calc(var(--font-size-base) * var(--font-scale) * 0.7);
      }
    }
  </style>
</head>
<body>
<header>
  <div class="header-title-container">
    <h1>1 Daily Calendar</h1>
    <div class="header-buttons">
      <button id="themeToggleBtn" aria-label="Toggle Theme">☀️</button>
      <button id="settingsBtn" aria-label="Settings">⚙️</button>
      <button id="statsBtn" aria-label="Statistics">📊</button>
      <button id="timerBtn" aria-label="Timer">⏰</button>
    </div>
  </div>
  <div>
    <button onclick="window.location.href='index2.html'">User Guide</button>
  </div>
</header>

<div id="searchBar">
  <input type="text" id="searchInput" placeholder="Search notes..." />
  <button id="searchBtn" aria-label="Search">🔍</button>
</div>

<div class="calendar-header">
  <h2 id="monthYear"></h2>
  <div class="calendar-controls">
    <button id="prevMonthBtn" aria-label="Previous Month">◀</button>
    <button id="todayBtn" aria-label="Today">Today</button>
    <button id="nextMonthBtn" aria-label="Next Month">▶</button>
    <button id="viewToggleBtn" aria-label="Toggle View">📅</button>
  </div>
</div>

<div class="calendar-grid" id="calendarGrid"></div>

<button id="floatingButton" aria-label="Add Note">+</button>

<div id="overlay"></div>
<div id="noteEditor" role="dialog" aria-modal="true" aria-labelledby="editorTitle">
  <h2 id="editorTitle">Add/Edit Note</h2>
  <label for="noteTitle">Title:</label>
  <input type="text" id="noteTitle" maxlength="50" placeholder="Enter note title" />
  <label for="noteBody">Details:</label>
  <textarea id="noteBody" placeholder="Enter note details"></textarea>
  <label for="noteColor">Color:</label>
  <input type="color" id="noteColor" value="#9747FF" />
  <label for="noteCategory">Category:</label>
  <select id="noteCategory">
    <option value="Work">Work</option>
    <option value="Personal">Personal</option>
    <option value="Other">Other</option>
  </select>
  <label for="notePriority">Priority:</label>
  <select id="notePriority">
    <option value="Low">Low</option>
    <option value="Medium">Medium</option>
    <option value="High">High</option>
  </select>
  <label for="noteRecurrence">Recurrence:</label>
  <select id="noteRecurrence">
    <option value="None">None</option>
    <option value="Daily">Daily</option>
    <option value="Weekly">Weekly</option>
    <option value="Monthly">Monthly</option>
  </select>
  <label for="noteAttachment">Attachment (URL):</label>
  <input type="url" id="noteAttachment" placeholder="Enter URL" />
  <div class="time-used" id="timeUsed"></div>
  <div class="reminder-section">
    <label for="noteReminder">Reminder (minutes before):</label>
    <input type="number" id="noteReminder" min="0" value="0" placeholder="Set to 0 to disable" />
  </div>
  <div class="editor-buttons">
    <button id="saveNoteBtn">Save</button>
    <button id="pinNoteBtn">📌 Pin</button>
    <button id="undoBtn">↺ Undo</button>
    <button id="redoBtn">↻ Redo</button>
    <button id="voiceInputBtn" aria-label="Voice Input">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
        <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm-1-9c0-.55.45-1 1-1s1 .45 1 1v6c0 .55-.45 1-1 1s-1-.45-1-1V5zm6 6c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.47 6 6.93V22h2v-3.07c3.39-.46 6-3.4 6-6.93h-2z"/>
      </svg>
    </button>
    <button id="shareNoteBtn">🔗 Share</button>
    <button id="closeNoteBtn">Close</button>
  </div>
</div>

<div id="searchPopup" role="dialog" aria-modal="true" aria-labelledby="searchTitle">
  <h2 id="searchTitle">Search Results</h2>
  <div id="searchResults"></div>
  <button id="closeSearchBtn">Close</button>
</div>

<div id="statsPopup" role="dialog" aria-modal="true" aria-labelledby="statsTitle">
  <h2 id="statsTitle">Statistics</h2>
  <pre id="statsContent"></pre>
  <button id="closeStatsBtn">Close</button>
</div>

<div id="settingsPopup" role="dialog" aria-modal="true" aria-labelledby="settingsTitle">
  <h2 id="settingsTitle">Settings</h2>
  <div class="settings-section">
    <label for="fontSize">Font Size:</label>
    <input type="range" id="fontSize" min="0.8" max="1.2" step="0.1" value="1" />
  </div>
  <div class="settings-section">
    <label for="themeSelect">Theme:</label>
    <select id="themeSelect">
      <option value="default">Default</option>
      <option value="blue">Blue</option>
      <option value="green">Green</option>
    </select>
    <label for="languageSelect">Language:</label>
    <select id="languageSelect">
      <option value="en">English</option>
      <option value="es">Spanish</option>
    </select>
    <label for="highContrast">High-Contrast Mode:</label>
    <input type="checkbox" id="highContrast" />
  </div>
  <div class="settings-section">
    <label for="reminderInterval">Reminder Interval (minutes):</label>
    <input type="number" id="reminderInterval" min="0" value="0" placeholder="Set to 0 to disable" />
    <label for="pomodoroDuration">Pomodoro Duration (minutes):</label>
    <input type="number" id="pomodoroDuration" min="1" value="25" />
    <label for="shortBreakDuration">Short Break Duration (minutes):</label>
    <input type="number" id="shortBreakDuration" min="1" value="5" />
    <label for="longBreakDuration">Long Break Duration (minutes):</label>
    <input type="number" id="longBreakDuration" min="1" value="15" />
  </div>
  <div class="settings-section">
    <label for="importData">Import Data:</label>
    <input type="file" id="importData" accept=".json" />
    <div class="file-info" id="fileInfo">No file chosen</div>
    <button id="exportDataBtn">Export Data</button>
  </div>
  <div class="settings-buttons">
    <button id="saveSettingsBtn">Save</button>
    <button id="closeSettingsBtn">Close</button>
  </div>
</div>

<div id="timerPopup" role="dialog" aria-modal="true" aria-labelledby="timerTitle">
  <h2 id="timerTitle">Pomodoro Timer</h2>
  <div class="timer-mode-buttons">
    <button id="pomodoroModeBtn" class="active">Pomodoro</button>
    <button id="shortBreakModeBtn">Short Break</button>
    <button id="longBreakModeBtn">Long Break</button>
  </div>
  <div class="timer-display" id="timerDisplay">25:00</div>
  <div class="timer-controls">
    <button id="timerStartBtn">Start</button>
    <button id="timerPauseBtn" disabled>Pause</button>
    <button id="timerResumeBtn" disabled>Resume</button>
    <button id="timerStopBtn" disabled>Stop</button>
    <button id="closeTimerBtn">Close</button>
  </div>
</div>

<audio id="timerAlarm" src="Elements/alarm.mp3"></audio>

<script>
(() => {
  const calendarGrid = document.getElementById('calendarGrid');
  const monthYear = document.getElementById('monthYear');
  const overlay = document.getElementById('overlay');
  const noteEditor = document.getElementById('noteEditor');
  const noteTitleInput = document.getElementById('noteTitle');
  const noteBodyInput = document.getElementById('noteBody');
  const noteColorInput = document.getElementById('noteColor');
  const noteCategorySelect = document.getElementById('noteCategory');
  const notePrioritySelect = document.getElementById('notePriority');
  const noteRecurrenceSelect = document.getElementById('noteRecurrence');
  const noteAttachmentInput = document.getElementById('noteAttachment');
  const noteReminderInput = document.getElementById('noteReminder');
  const saveNoteBtn = document.getElementById('saveNoteBtn');
  const pinNoteBtn = document.getElementById('pinNoteBtn');
  const undoBtn = document.getElementById('undoBtn');
  const redoBtn = document.getElementById('redoBtn');
  const voiceInputBtn = document.getElementById('voiceInputBtn');
  const shareNoteBtn = document.getElementById('shareNoteBtn');
  const closeNoteBtn = document.getElementById('closeNoteBtn');
  const searchInput = document.getElementById('searchInput');
  const searchBtn = document.getElementById('searchBtn');
  const searchPopup = document.getElementById('searchPopup');
  const searchResults = document.getElementById('searchResults');
  const closeSearchBtn = document.getElementById('closeSearchBtn');
  const statsPopup = document.getElementById('statsPopup');
  const statsContent = document.getElementById('statsContent');
  const closeStatsBtn = document.getElementById('closeStatsBtn');
  const settingsPopup = document.getElementById('settingsPopup');
  const fontSizeInput = document.getElementById('fontSize');
  const themeSelect = document.getElementById('themeSelect');
  const languageSelect = document.getElementById('languageSelect');
  const highContrastCheckbox = document.getElementById('highContrast');
  const reminderIntervalInput = document.getElementById('reminderInterval');
  const pomodoroDurationInput = document.getElementById('pomodoroDuration');
  const shortBreakDurationInput = document.getElementById('shortBreakDuration');
  const longBreakDurationInput = document.getElementById('longBreakDuration');
  const importDataInput = document.getElementById('importData');
  const fileInfo = document.getElementById('fileInfo');
  const exportDataBtn = document.getElementById('exportDataBtn');
  const saveSettingsBtn = document.getElementById('saveSettingsBtn');
  const closeSettingsBtn = document.getElementById('closeSettingsBtn');
  const timerPopup = document.getElementById('timerPopup');
  const timerDisplay = document.getElementById('timerDisplay');
  const pomodoroModeBtn = document.getElementById('pomodoroModeBtn');
  const shortBreakModeBtn = document.getElementById('shortBreakModeBtn');
  const longBreakModeBtn = document.getElementById('longBreakModeBtn');
  const timerStartBtn = document.getElementById('timerStartBtn');
  const timerPauseBtn = document.getElementById('timerPauseBtn');
  const timerResumeBtn = document.getElementById('timerResumeBtn');
  const timerStopBtn = document.getElementById('timerStopBtn');
  const closeTimerBtn = document.getElementById('closeTimerBtn');
  const timerAlarm = document.getElementById('timerAlarm');
  const themeToggleBtn = document.getElementById('themeToggleBtn');
  const settingsBtn = document.getElementById('settingsBtn');
  const statsBtn = document.getElementById('statsBtn');
  const timerBtn = document.getElementById('timerBtn');
  const prevMonthBtn = document.getElementById('prevMonthBtn');
  const todayBtn = document.getElementById('todayBtn');
  const nextMonthBtn = document.getElementById('nextMonthBtn');
  const viewToggleBtn = document.getElementById('viewToggleBtn');
  const floatingButton = document.getElementById('floatingButton');

  let currentDate = new Date(2025, 4, 24);
  let currentView = 'month';
  let notes = JSON.parse(localStorage.getItem('calendarNotes')) || {};
  let focusData = JSON.parse(localStorage.getItem('focusData')) || {};
  let undoStack = [];
  let redoStack = [];
  let currentNote = null;
  let currentDateKey = '';
  let lightTheme = false;
  let timer;
  let timerTime = 1500;
  let timerMode = 'pomodoro';
  let timerRunning = false;
  let timerPaused = false;
  let timerDurations = { pomodoro: 25 * 60, short: 5 * 60, long: 15 * 60 };
  let reminderInterval = 0;
  let lastReminderTime = Date.now();

  const holidays = {
    '2025-01-01': 'New Year',
    '2025-12-25': 'Christmas'
  };

  function init() {
    loadTheme();
    loadSettings();
    renderCalendar();
    bindEvents();
    requestNotificationPermission();
    scheduleReminders();
  }

  function loadTheme() {
    lightTheme = localStorage.getItem('theme') === 'light';
    document.body.classList.toggle('light', lightTheme);
    themeToggleBtn.textContent = lightTheme ? '🌙' : '☀️';
  }

  function loadSettings() {
    const savedSettings = JSON.parse(localStorage.getItem('calendarSettings')) || {};
    if (savedSettings.fontSize) {
      document.documentElement.style.setProperty('--font-scale', savedSettings.fontSize);
      fontSizeInput.value = savedSettings.fontSize;
    }
    if (savedSettings.theme) {
      updateTheme(savedSettings.theme);
      themeSelect.value = savedSettings.theme;
    }
    if (savedSettings.highContrast) {
      toggleHighContrast(savedSettings.highContrast);
      highContrastCheckbox.checked = savedSettings.highContrast;
    }
    if (savedSettings.reminderInterval) {
      reminderInterval = savedSettings.reminderInterval;
      reminderIntervalInput.value = reminderInterval / 60;
    }
    if (savedSettings.timerDurations) {
      timerDurations = savedSettings.timerDurations;
      pomodoroDurationInput.value = timerDurations.pomodoro / 60;
      shortBreakDurationInput.value = timerDurations.short / 60;
      longBreakDurationInput.value = timerDurations.long / 60;
      timerTime = timerDurations[timerMode];
      updateTimerDisplay();
    }
  }

  function saveSettings() {
    const settings = {
      fontSize: fontSizeInput.value,
      theme: themeSelect.value,
      language: languageSelect.value,
      highContrast: highContrastCheckbox.checked,
      reminderInterval: parseInt(reminderIntervalInput.value) * 60,
      timerDurations: {
        pomodoro: parseInt(pomodoroDurationInput.value) * 60,
        short: parseInt(shortBreakDurationInput.value) * 60,
        long: parseInt(longBreakDurationInput.value) * 60
      }
    };
    reminderInterval = settings.reminderInterval;
    timerDurations = settings.timerDurations;
    timerTime = timerDurations[timerMode];
    updateTimerDisplay();
    document.documentElement.style.setProperty('--font-scale', settings.fontSize);
    localStorage.setItem('calendarSettings', JSON.stringify(settings));
    closeSettingsPopup();
  }

  function bindEvents() {
    themeToggleBtn.onclick = () => {
      lightTheme = !lightTheme;
      document.body.classList.toggle('light', lightTheme);
      themeToggleBtn.textContent = lightTheme ? '🌙' : '☀️';
      localStorage.setItem('theme', lightTheme ? 'light' : 'dark');
    };
    settingsBtn.onclick = openSettingsPopup;
    statsBtn.onclick = openStatsPopup;
    timerBtn.onclick = openTimerPopup;
    prevMonthBtn.onclick = prevMonth;
    todayBtn.onclick = goToToday;
    nextMonthBtn.onclick = nextMonth;
    viewToggleBtn.onclick = toggleView;
    floatingButton.onclick = () => openNoteEditor(new Date());
    saveNoteBtn.onclick = saveNote;
    pinNoteBtn.onclick = pinNote;
    undoBtn.onclick = undo;
    redoBtn.onclick = redo;
    voiceInputBtn.onclick = startVoiceInput;
    shareNoteBtn.onclick = shareNote;
    closeNoteBtn.onclick = closeNoteEditor;
    searchInput.oninput = searchNotes;
    searchBtn.onclick = openSearchPopup;
    closeSearchBtn.onclick = closeSearchPopup;
    closeStatsBtn.onclick = closeStatsPopup;
    saveSettingsBtn.onclick = saveSettings;
    closeSettingsBtn.onclick = closeSettingsPopup;
    exportDataBtn.onclick = exportData;
    importDataInput.onchange = importData;
    pomodoroModeBtn.onclick = () => setTimerMode('pomodoro');
    shortBreakModeBtn.onclick = () => setTimerMode('short');
    longBreakModeBtn.onclick = () => setTimerMode('long');
    timerStartBtn.onclick = startTimer;
    timerPauseBtn.onclick = pauseTimer;
    timerResumeBtn.onclick = resumeTimer;
    timerStopBtn.onclick = stopTimer;
    closeTimerBtn.onclick = closeTimerPopup;
    overlay.onclick = closeAllPopups;
    fontSizeInput.oninput = () => {
      document.documentElement.style.setProperty('--font-scale', fontSizeInput.value);
    };
    themeSelect.onchange = () => updateTheme(themeSelect.value);
    highContrastCheckbox.onchange = () => toggleHighContrast(highContrastCheckbox.checked);
    document.addEventListener('keydown', handleKeyboardShortcuts);
  }

  function renderCalendar() {
    calendarGrid.innerHTML = '';
    const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    days.forEach(day => {
      const dayHeader = document.createElement('div');
      dayHeader.className = 'day-header';
      dayHeader.textContent = day;
      calendarGrid.appendChild(dayHeader);
    });

    const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1).getDay();
    const daysInMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0).getDate();
    monthYear.textContent = `${currentDate.toLocaleString('default', { month: 'long' })} ${currentDate.getFullYear()}`;

    if (currentView === 'month') {
      for (let i = 0; i < firstDay; i++) {
        const emptyDay = document.createElement('div');
        calendarGrid.appendChild(emptyDay);
      }
      for (let day = 1; day <= daysInMonth; day++) {
        renderDay(day);
      }
    } else if (currentView === 'week') {
      const startOfWeek = new Date(currentDate);
      startOfWeek.setDate(currentDate.getDate() - currentDate.getDay());
      for (let d = 0; d < 7; d++) {
        const day = new Date(startOfWeek);
        day.setDate(startOfWeek.getDate() + d);
        renderDay(day.getDate(), day.getFullYear(), day.getMonth());
      }
    } else if (currentView === 'day') {
      renderDay(currentDate.getDate(), currentDate.getFullYear(), currentDate.getMonth());
    }
  }

  function renderDay(day, year = currentDate.getFullYear(), month = currentDate.getMonth()) {
    const date = new Date(year, month, day);
    const dateKey = date.toISOString().split('T')[0];
    const dayDiv = document.createElement('div');
    dayDiv.className = 'day';
    if (dateKey === new Date().toISOString().split('T')[0]) {
      dayDiv.classList.add('today');
    }
    if (holidays[dateKey]) {
      dayDiv.classList.add('holiday');
    }
    dayDiv.innerHTML = `<span class="day-number">${day}</span>`;
    const notesDiv = document.createElement('div');
    notesDiv.className = 'notes';
    const dayNotes = notes[dateKey] || [];
    dayNotes.sort((a, b) => b.pinned - a.pinned);
    dayNotes.forEach(note => {
      const noteDiv = document.createElement('div');
      noteDiv.className = 'note';
      if (note.pinned) noteDiv.classList.add('pinned');
      noteDiv.style.backgroundColor = note.color + '33';
      noteDiv.textContent = note.title || '(No Title)';
      notesDiv.appendChild(noteDiv);
    });
    dayDiv.appendChild(notesDiv);
    dayDiv.onclick = () => openNoteEditor(date);
    calendarGrid.appendChild(dayDiv);
  }

  function prevMonth() {
    currentDate.setMonth(currentDate.getMonth() - 1);
    renderCalendar();
  }

  function nextMonth() {
    currentDate.setMonth(currentDate.getMonth() + 1);
    renderCalendar();
  }

  function goToToday() {
    currentDate = new Date();
    renderCalendar();
  }

  function toggleView() {
    currentView = currentView === 'month' ? 'week' : currentView === 'week' ? 'day' : 'month';
    renderCalendar();
  }

  function openNoteEditor(date) {
    currentDateKey = date.toISOString().split('T')[0];
    document.getElementById('editorTitle').textContent = `Add/Edit Note - ${currentDateKey}`;
    const dayNotes = notes[currentDateKey] || [];
    const firstNote = dayNotes[0] || {
      title: '',
      body: '',
      color: '#9747FF',
      category: 'Work',
      priority: 'Low',
      recurrence: 'None',
      attachment: '',
      reminder: 0,
      pinned: false
    };
    currentNote = dayNotes[0] || null;
    noteTitleInput.value = firstNote.title;
    noteBodyInput.value = firstNote.body;
    noteColorInput.value = firstNote.color;
    noteCategorySelect.value = firstNote.category;
    notePrioritySelect.value = firstNote.priority;
    noteRecurrenceSelect.value = firstNote.recurrence;
    noteAttachmentInput.value = firstNote.attachment;
    noteReminderInput.value = firstNote.reminder / 60 || '0';
    pinNoteBtn.textContent = firstNote.pinned ? '📍 Unpin' : '📌 Pin';
    undoStack = [];
    redoStack = [];
    updateTimeUsed();
    noteEditor.classList.add('open');
    overlay.classList.add('open');
  }

  function updateTimeUsed() {
    const mins = Math.floor((focusData[currentDateKey] || 0) / 60);
    document.getElementById('timeUsed').textContent = `Focus Time on ${currentDateKey}: ${mins} min`;
  }

  function saveNote() {
    const note = {
      title: noteTitleInput.value.trim(),
      body: noteBodyInput.value.trim(),
      color: noteColorInput.value,
      category: noteCategorySelect.value,
      priority: notePrioritySelect.value,
      recurrence: noteRecurrenceSelect.value,
      attachment: noteAttachmentInput.value.trim(),
      reminder: parseInt(noteReminderInput.value) * 60,
      pinned: pinNoteBtn.textContent.includes('Unpin')
    };
    if (!notes[currentDateKey]) notes[currentDateKey] = [];
    if (currentNote) {
      const index = notes[currentDateKey].indexOf(currentNote);
      notes[currentDateKey][index] = note;
    } else {
      notes[currentDateKey].push(note);
    }
    if (note.title === '' && note.body === '') {
      notes[currentDateKey] = notes[currentDateKey].filter(n => n !== note);
      if (notes[currentDateKey].length === 0) delete notes[currentDateKey];
    }
    if (note.recurrence !== 'None') {
      applyRecurrence(note);
    }
    if (note.reminder > 0) {
      scheduleReminder(note, currentDateKey);
    }
    localStorage.setItem('calendarNotes', JSON.stringify(notes));
    renderCalendar();
    closeNoteEditor();
  }

  function applyRecurrence(note) {
    const [year, month, day] = currentDateKey.split('-').map(Number);
    let date = new Date(year, month - 1, day);
    const endDate = new Date(year + 1, month - 1, day);
    while (date <= endDate) {
      const dateKey = date.toISOString().split('T')[0];
      if (note.recurrence === 'Daily') {
        if (!notes[dateKey]) notes[dateKey] = [];
        if (!notes[dateKey].some(n => n.title === note.title && n.body === note.body)) {
          notes[dateKey].push({ ...note });
        }
      } else if (note.recurrence === 'Weekly' && date.getDay() === new Date(currentDateKey).getDay()) {
        if (!notes[dateKey]) notes[dateKey] = [];
        if (!notes[dateKey].some(n => n.title === note.title && n.body === note.body)) {
          notes[dateKey].push({ ...note });
        }
      } else if (note.recurrence === 'Monthly' && date.getDate() === day) {
        if (!notes[dateKey]) notes[dateKey] = [];
        if (!notes[dateKey].some(n => n.title === note.title && n.body === note.body)) {
          notes[dateKey].push({ ...note });
        }
      }
      date.setDate(date.getDate() + 1);
    }
  }

  function scheduleReminder(note, dateKey) {
    const reminderTime = new Date(dateKey);
    reminderTime.setSeconds(reminderTime.getSeconds() - note.reminder);
    const now = new Date();
    const timeDiff = reminderTime - now;
    if (timeDiff > 0 && Notification.permission === 'granted') {
      setTimeout(() => {
        new Notification('1 Daily Calendar Reminder', {
          body: `Reminder: ${note.title}`,
          icon: 'Elements/myLogo.jpg'
        });
      }, timeDiff);
    }
  }

  function scheduleReminders() {
    if (Notification.permission !== 'granted') return;
    for (const [dateKey, dayNotes] of Object.entries(notes)) {
      dayNotes.forEach(note => {
        if (note.reminder > 0) {
          scheduleReminder(note, dateKey);
        }
      });
    }
  }

  function pinNote() {
    if (currentNote) {
      currentNote.pinned = !currentNote.pinned;
      pinNoteBtn.textContent = currentNote.pinned ? '📍 Unpin' : '📌 Pin';
    } else {
      pinNoteBtn.textContent = '📍 Unpin';
    }
  }

  function undo() {
    if (undoStack.length === 0) return;
    const lastState = undoStack.pop();
    redoStack.push({
      title: noteTitleInput.value,
      body: noteBodyInput.value,
      color: noteColorInput.value,
      category: noteCategorySelect.value,
      priority: notePrioritySelect.value,
      recurrence: noteRecurrenceSelect.value,
      attachment: noteAttachmentInput.value,
      reminder: noteReminderInput.value
    });
    noteTitleInput.value = lastState.title;
    noteBodyInput.value = lastState.body;
    noteColorInput.value = lastState.color;
    noteCategorySelect.value = lastState.category;
    notePrioritySelect.value = lastState.priority;
    noteRecurrenceSelect.value = lastState.recurrence;
    noteAttachmentInput.value = lastState.attachment;
    noteReminderInput.value = lastState.reminder;
    undoBtn.disabled = undoStack.length === 0;
    redoBtn.disabled = false;
  }

  function redo() {
    if (redoStack.length === 0) return;
    const nextState = redoStack.pop();
    undoStack.push({
      title: noteTitleInput.value,
      body: noteBodyInput.value,
      color: noteColorInput.value,
      category: noteCategorySelect.value,
      priority: notePrioritySelect.value,
      recurrence: noteRecurrenceSelect.value,
      attachment: noteAttachmentInput.value,
      reminder: noteReminderInput.value
    });
    noteTitleInput.value = nextState.title;
    noteBodyInput.value = nextState.body;
    noteColorInput.value = nextState.color;
    noteCategorySelect.value = nextState.category;
    notePrioritySelect.value = nextState.priority;
    noteRecurrenceSelect.value = nextState.recurrence;
    noteAttachmentInput.value = nextState.attachment;
    noteReminderInput.value = nextState.reminder;
    redoBtn.disabled = redoStack.length === 0;
    undoBtn.disabled = false;
  }

  function startVoiceInput() {
    const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    recognition.lang = 'en-US';
    recognition.onresult = (event) => {
      const transcript = event.results[0][0].transcript;
      noteBodyInput.value += transcript + ' ';
      undoStack.push({
        title: noteTitleInput.value,
        body: noteBodyInput.value,
        color: noteColorInput.value,
        category: noteCategorySelect.value,
        priority: notePrioritySelect.value,
        recurrence: noteRecurrenceSelect.value,
        attachment: noteAttachmentInput.value,
        reminder: noteReminderInput.value
      });
      redoStack = [];
      undoBtn.disabled = false;
      redoBtn.disabled = true;
    };
    recognition.onerror = () => {
      alert('Voice input failed. Please ensure your browser supports speech recognition and your microphone is enabled.');
    };
    recognition.start();
  }

  function shareNote() {
    const note = {
      title: noteTitleInput.value,
      body: noteBodyInput.value,
      date: currentDateKey
    };
    const shareText = `${note.title}\n${note.body}\nDate: ${note.date}`;
    navigator.clipboard.writeText(shareText).then(() => {
      alert('Note copied to clipboard!');
    });
  }

  function closeNoteEditor() {
    noteEditor.classList.remove('open');
    overlay.classList.remove('open');
    currentNote = null;
    currentDateKey = '';
  }

  function searchNotes() {
    const query = searchInput.value.toLowerCase();
    const results = [];
    for (const dateKey in notes) {
      notes[dateKey].forEach(note => {
        if (
          note.title.toLowerCase().includes(query) ||
          note.body.toLowerCase().includes(query) ||
          note.category.toLowerCase().includes(query) ||
          dateKey.includes(query)
        ) {
          results.push({ date: dateKey, note });
        }
      });
    }
    displaySearchResults(results);
  }

  function displaySearchResults(results) {
    searchResults.innerHTML = '';
    results.forEach(result => {
      const resultDiv = document.createElement('div');
      resultDiv.className = 'search-result';
      resultDiv.textContent = `${result.date}: ${result.note.title || '(No Title)'}`;
      resultDiv.onclick = () => {
        currentDate = new Date(result.date);
        renderCalendar();
        openNoteEditor(new Date(result.date));
        currentNote = result.note;
        noteTitleInput.value = result.note.title;
        noteBodyInput.value = result.note.body;
        noteColorInput.value = result.note.color;
        noteCategorySelect.value = result.note.category;
        notePrioritySelect.value = result.note.priority;
        noteRecurrenceSelect.value = result.note.recurrence;
        noteAttachmentInput.value = result.note.attachment;
        noteReminderInput.value = result.note.reminder / 60;
        pinNoteBtn.textContent = result.note.pinned ? '📍 Unpin' : '📌 Pin';
        closeSearchPopup();
      };
      searchResults.appendChild(resultDiv);
    });
  }

  function openSearchPopup() {
    if (searchResults.children.length > 0) {
      searchPopup.classList.add('open');
      overlay.classList.add('open');
    }
  }

  function closeSearchPopup() {
    searchPopup.classList.remove('open');
    overlay.classList.remove('open');
  }

  function openStatsPopup() {
    const totalNotes = Object.values(notes).flat().length;
    let activeDays = 0;
    for (const dateKey in notes) {
      if (notes[dateKey].length > 0) activeDays++;
    }
    let dailyReport = '';
    let weeklyReport = '';
    let monthlyReport = '';
    const now = new Date();
    const todayKey = now.toISOString().split('T')[0];
    dailyReport = `📌 Today (${todayKey}): ${Math.floor((focusData[todayKey] || 0) / 60)} min\n`;
    for (const key in focusData) {
      if (key.includes('-') && !key.startsWith('month-') && !key.startsWith('year-') && key !== todayKey) {
        dailyReport += `📌 ${key}: ${Math.floor(focusData[key] / 60)} min\n`;
      }
    }
    const weekData = {};
    for (const key in focusData) {
      if (key.includes('-') && !key.startsWith('month-') && !key.startsWith('year-')) {
        const date = new Date(key);
        const firstDayOfYear = new Date(date.getFullYear(), 0, 1);
        const pastDaysOfYear = (date - firstDayOfYear) / 86400000;
        const weekNumber = Math.ceil((pastDaysOfYear + firstDayOfYear.getDay() + 1) / 7);
        const weekKey = `${date.getFullYear()}-W${String(weekNumber).padStart(2, '0')}`;
        weekData[weekKey] = (weekData[weekKey] || 0) + (focusData[key] || 0);
      }
    }
    for (const week in weekData) {
      weeklyReport += `📅 Week ${week}: ${Math.floor(weekData[week] / 60)} min\n`;
    }
    for (const key in focusData) {
      if (key.startsWith('month-')) {
        monthlyReport += `📆 ${key.split('-')[1]}: ${Math.floor(focusData[key] / 60)} min\n`;
      }
    }
    const stats = `Total Notes: ${totalNotes}\nMost Active Days: ${activeDays}\n\n` +
                  `Daily Focus Time:\n${dailyReport || 'No daily data.\n'}\n` +
                  `Weekly Focus Time:\n${weeklyReport || 'No weekly data.\n'}\n` +
                  `Monthly Focus Time:\n${monthlyReport || 'No monthly data.\n'}`;
    statsContent.textContent = stats;
    statsPopup.classList.add('open');
    overlay.classList.add('open');
  }

  function closeStatsPopup() {
    statsPopup.classList.remove('open');
    overlay.classList.remove('open');
  }

  function openSettingsPopup() {
    settingsPopup.classList.add('open');
    overlay.classList.add('open');
    fileInfo.textContent = 'No file chosen';
  }

  function closeSettingsPopup() {
    settingsPopup.classList.remove('open');
    overlay.classList.remove('open');
  }

  function updateTheme(theme) {
    document.body.classList.remove('theme-blue', 'theme-green');
    if (theme !== 'default') {
      document.body.classList.add(`theme-${theme}`);
    }
  }

  function toggleHighContrast(enabled) {
    document.body.classList.toggle('high-contrast', enabled);
  }

  function exportData() {
    const data = {
      notes: notes,
      focusData: focusData,
      settings: JSON.parse(localStorage.getItem('calendarSettings')) || {}
    };
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'daily_calendar_data.json';
    a.click();
    URL.revokeObjectURL(url);
  }

  function importData(event) {
    const file = event.target.files[0];
    if (!file) {
      fileInfo.textContent = 'No file chosen';
      return;
    }
    fileInfo.textContent = `Chosen file: ${file.name}`;
    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const data = JSON.parse(e.target.result);
        // Check if the data is in the legacy format (simple key-value pairs of dates and notes)
        if (!data.notes && !data.focusData && !data.settings) {
          const convertedNotes = {};
          for (const [dateKey, note] of Object.entries(data)) {
            convertedNotes[dateKey] = [{
              title: note.title || '',
              body: note.body || '',
              color: '#9747FF', // Default values for new fields
              category: 'Work',
              priority: 'Low',
              recurrence: 'None',
              attachment: '',
              reminder: 0,
              pinned: false
            }];
          }
          notes = convertedNotes;
          localStorage.setItem('calendarNotes', JSON.stringify(notes));
          renderCalendar();
          alert('Legacy data imported successfully!');
        } else {
          // Handle the current format
          if (data.notes) {
            notes = data.notes;
            localStorage.setItem('calendarNotes', JSON.stringify(notes));
          }
          if (data.focusData) {
            focusData = data.focusData;
            localStorage.setItem('focusData', JSON.stringify(focusData));
          }
          if (data.settings) {
            localStorage.setItem('calendarSettings', JSON.stringify(data.settings));
            loadSettings();
          }
          renderCalendar();
          alert('Data imported successfully!');
        }
      } catch (err) {
        alert('Failed to import data. Please ensure the file is a valid JSON.');
        fileInfo.textContent = 'Failed to import. Invalid file.';
      }
    };
    reader.readAsText(file);
  }

  function openTimerPopup() {
    timerTime = timerDurations[timerMode];
    updateTimerDisplay();
    timerPopup.classList.add('open');
    overlay.classList.add('open');
  }

  function closeTimerPopup() {
    stopTimer();
    timerPopup.classList.remove('open');
    overlay.classList.remove('open');
  }

  function setTimerMode(newMode) {
    document.querySelectorAll('.timer-mode-buttons button').forEach(btn => btn.classList.remove('active'));
    if (newMode === 'pomodoro') pomodoroModeBtn.classList.add('active');
    else if (newMode === 'short') shortBreakModeBtn.classList.add('active');
    else if (newMode === 'long') longBreakModeBtn.classList.add('active');
    timerMode = newMode;
    timerTime = timerDurations[timerMode];
    updateTimerDisplay();
    stopTimer();
  }

  function updateTimerDisplay() {
    const minutes = Math.floor(timerTime / 60).toString().padStart(2, '0');
    const seconds = (timerTime % 60).toString().padStart(2, '0');
    timerDisplay.textContent = `${minutes}:${seconds}`;
  }

  function startTimer() {
    if (timerRunning) return;
    timerRunning = true;
    timerPaused = false;
    timerStartBtn.disabled = true;
    timerPauseBtn.disabled = false;
    timerResumeBtn.disabled = true;
    timerStopBtn.disabled = false;
    timer = setInterval(() => {
      timerTime--;
      updateTimerDisplay();
      checkReminder();
      if (timerTime <= 0) {
        clearInterval(timer);
        timerRunning = false;
        timerAlarm.play().catch(err => console.error('Failed to play alarm:', err));
        recordFocusTime(timerDurations[timerMode]);
        autoSwitchTimerMode();
      }
    }, 1000);
  }

  function pauseTimer() {
    if (!timerRunning || timerPaused) return;
    clearInterval(timer);
    timerRunning = false;
    timerPaused = true;
    timerStartBtn.disabled = true;
    timerPauseBtn.disabled = true;
    timerResumeBtn.disabled = false;
    timerStopBtn.disabled = false;
    if (timerMode === 'pomodoro') {
      const used = timerDurations.pomodoro - timerTime;
      recordFocusTime(used);
    }
  }

  function resumeTimer() {
    if (timerRunning || !timerPaused) return;
    startTimer();
  }

  function stopTimer() {
    clearInterval(timer);
    timerRunning = false;
    timerPaused = false;
    timerStartBtn.disabled = false;
    timerPauseBtn.disabled = true;
    timerResumeBtn.disabled = true;
    timerStopBtn.disabled = true;
    timerTime = timerDurations[timerMode];
    updateTimerDisplay();
  }

  function autoSwitchTimerMode() {
    if (timerMode === 'pomodoro') {
      setTimerMode('short');
      startTimer();
    } else {
      setTimerMode('pomodoro');
      startTimer();
    }
  }

  function recordFocusTime(seconds) {
    if (timerMode !== 'pomodoro') return;
    const todayKey = new Date().toISOString().split('T')[0];
    const monthKey = `${new Date().getFullYear()}-${String(new Date().getMonth() + 1).padStart(2, '0')}`;
    const yearKey = `${new Date().getFullYear()}`;
    focusData[todayKey] = (focusData[todayKey] || 0) + seconds;
    const storedMonth = localStorage.getItem('lastMonthKey');
    if (storedMonth && storedMonth !== monthKey) {
      let monthTotal = 0;
      for (const key in focusData) {
        if (key.startsWith(storedMonth)) {
          monthTotal += focusData[key];
          delete focusData[key];
        }
      }
      focusData[`month-${storedMonth}`] = monthTotal;
    }
    localStorage.setItem('lastMonthKey', monthKey);
    const storedYear = localStorage.getItem('lastYearKey');
    if (storedYear && storedYear !== yearKey) {
      let yearTotal = 0;
      for (const key in focusData) {
        if (key.startsWith(`month-${storedYear}`)) {
          yearTotal += focusData[key];
          delete focusData[key];
        }
      }
      focusData[`year-${storedYear}`] = yearTotal;
    }
    localStorage.setItem('lastYearKey', yearKey);
    localStorage.setItem('focusData', JSON.stringify(focusData));
    updateTimeUsed();
  }

  function requestNotificationPermission() {
    if (Notification.permission !== 'granted' && Notification.permission !== 'denied') {
      Notification.requestPermission();
    }
  }

  function checkReminder() {
    if (reminderInterval === 0 || !timerRunning) return;
    const now = Date.now();
    if ((now - lastReminderTime) / 1000 >= reminderInterval) {
      if (Notification.permission === 'granted') {
        new Notification('1 Daily Calendar Reminder', {
          body: 'Keep focused! Take a break if needed.',
          icon: 'Elements/myLogo.jpg'
        });
      }
      lastReminderTime = now;
    }
  }

  function closeAllPopups() {
    closeNoteEditor();
    closeSearchPopup();
    closeStatsPopup();
    closeSettingsPopup();
    closeTimerPopup();
  }

  function handleKeyboardShortcuts(e) {
    if (e.ctrlKey && e.key === 't') goToToday();
    if (e.ctrlKey && e.key === 'n') openNoteEditor(new Date());
  }

  init();
})();
</script>
</body>
</html>
